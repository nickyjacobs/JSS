<!DOCTYPE html>
<html lang="{{ lang }}">
  <head>
    <meta charset="UTF-8" />
    <title>{{ t.title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <style>
      /* Force dark table backgrounds */
      .ndt-card-dark .table tbody tr {
        background-color: rgba(15, 23, 42, 0.4) !important;
      }
      .ndt-card-dark .table tbody tr:nth-child(even) {
        background-color: rgba(15, 23, 42, 0.5) !important;
      }
      .ndt-card-dark .table tbody td {
        background-color: transparent !important;
        color: #cbd5e1 !important;
      }
      .ndt-card-dark .table tbody tr:hover {
        background-color: rgba(59, 130, 246, 0.15) !important;
      }
      
      body.light-theme {
        background: #f8f9fa;
        color: #212529;
      }
      body.light-theme .ndt-gradient {
        opacity: 0.3;
      }
      body.light-theme .text-white {
        color: #212529 !important;
      }
      body.light-theme .text-light {
        color: #495057 !important;
      }
      body.light-theme .ndt-stat-card {
        background: #ffffff;
        border: 1px solid #dee2e6;
        color: #212529;
      }
      body.light-theme .ndt-card {
        background: #ffffff;
      }
    </style>
  </head>
  <body class="ndt-body {% if theme == 'light' %}light-theme{% endif %}">
    <div class="ndt-gradient"></div>
    <div class="container py-4 position-relative">
      <!-- Header met taal/theme switchers -->
      <div class="row mb-4">
        <div class="col-12 col-lg-8">
          <div class="d-flex align-items-center gap-3">
            <div class="ndt-logo-circle">
              <span class="ndt-logo-dot"></span>
            </div>
            <div>
              <h1 class="h3 mb-1 {% if theme == 'light' %}text-dark{% else %}text-white{% endif %}">{{ t.title }}</h1>
              <p class="{% if theme == 'light' %}text-dark{% else %}text-light{% endif %} opacity-75 small mb-0">
                {{ t.subtitle }}
              </p>
              {% if current_subnet %}
                <p class="{% if theme == 'light' %}text-dark{% else %}text-light{% endif %} small mb-0 mt-1">
                  {{ t.subnet }}: <code class="ndt-code-light">{{ current_subnet }}</code>
                </p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4 mt-3 mt-lg-0 d-flex justify-content-lg-end align-items-start gap-2 flex-wrap">
          <!-- Taal switcher en Export -->
          <div class="d-flex gap-2">
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn ndt-btn-modern ndt-btn-secondary dropdown-toggle" data-bs-toggle="dropdown" id="lang-dropdown-btn">
                {% if lang == 'nl' %}üá≥üá± Nederlands{% else %}üá¨üáß English{% endif %}
              </button>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item lang-btn {% if lang == 'nl' %}active{% endif %}" href="#" data-lang="nl">üá≥üá± Nederlands</a></li>
                <li><a class="dropdown-item lang-btn {% if lang == 'en' %}active{% endif %}" href="#" data-lang="en">üá¨üáß English</a></li>
              </ul>
            </div>
            {% if devices %}
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn ndt-btn-modern ndt-btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                {{ t.export }}
              </button>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="{{ url_for('export_json') }}">JSON</a></li>
                <li><a class="dropdown-item" href="{{ url_for('export_csv') }}">CSV</a></li>
              </ul>
            </div>
            {% endif %}
          </div>
          
          <!-- Scan form -->
          <form
            class="d-flex flex-column flex-sm-row gap-2 ndt-header-form"
            method="post"
            action="{{ url_for('trigger_scan') }}"
            id="scan-form"
          >
            <label class="ndt-toggle-switch" for="enable-osint">
              <input class="ndt-toggle-input" type="checkbox" id="enable-osint" name="enable_osint" value="true">
              <span class="ndt-toggle-slider"></span>
              <span class="ndt-toggle-label">OSINT</span>
            </label>
            <label class="ndt-toggle-switch" for="enable-portscan">
              <input class="ndt-toggle-input" type="checkbox" id="enable-portscan" name="enable_portscan" value="true">
              <span class="ndt-toggle-slider"></span>
              <span class="ndt-toggle-label">Ports</span>
            </label>
            <button class="btn ndt-btn-modern ndt-btn-primary ndt-scan-btn" type="submit" id="scan-btn">
              <span class="ndt-scan-text">{{ t.scan_button }}</span>
              <span class="ndt-scan-loader d-none">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ t.scanning }}
              </span>
            </button>
          </form>
        </div>
      </div>

      <!-- Stats en History -->
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-3">
          <div class="ndt-stat-card">
            <div class="ndt-stat-label">{{ t.devices }}</div>
            <div class="ndt-stat-value" id="device-count">
              {{ devices | length if devices else 0 }}
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="ndt-stat-card">
            <div class="ndt-stat-label">{{ t.last_scan }}</div>
            <div class="ndt-stat-value ndt-stat-small">
              {% if timestamp %}
                {{ timestamp.strftime('%H:%M:%S') if timestamp else timestamp }}
              {% else %}
                {{ t.not_scanned }}
              {% endif %}
            </div>
          </div>
        </div>
        {% if history %}
        <div class="col-6 col-md-3">
          <div class="ndt-stat-card">
            <div class="ndt-stat-label">{{ t.scan_history }}</div>
            <div class="ndt-stat-value ndt-stat-small">
              {{ history | length }} scans
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Filters -->
      {% if devices %}
      <div class="card shadow-sm ndt-card ndt-card-dark mb-3">
        <div class="card-body py-2">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <strong class="small me-2">{{ t.filter_all }}:</strong>
            <div class="btn-group btn-group-sm" role="group">
              <input type="radio" class="btn-check" name="filter" id="filter-all" value="all" checked>
              <label class="btn btn-outline-secondary" for="filter-all">{{ t.filter_all }}</label>
              
              <input type="radio" class="btn-check" name="filter" id="filter-known" value="known">
              <label class="btn btn-outline-secondary" for="filter-known">{{ t.filter_known }}</label>
              
              <input type="radio" class="btn-check" name="filter" id="filter-unknown" value="unknown">
              <label class="btn btn-outline-secondary" for="filter-unknown">{{ t.filter_unknown }}</label>
              
              <input type="radio" class="btn-check" name="filter" id="filter-external" value="external">
              <label class="btn btn-outline-secondary" for="filter-external">{{ t.filter_external }}</label>
              
              <input type="radio" class="btn-check" name="filter" id="filter-new" value="new">
              <label class="btn btn-outline-secondary" for="filter-new">{{ t.filter_new }}</label>
            </div>
            <div class="flex-grow-1" style="max-width: 300px;">
              <input
                type="text"
                class="form-control form-control-sm"
                id="search-input"
                placeholder="{{ t.search_placeholder }}"
              />
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Main devices table -->
      <div class="card shadow-sm ndt-card ndt-card-dark">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div>
              <h2 class="h5 mb-1">{{ t.devices_in_subnet }}</h2>
              {% if timestamp %}
                <p class="text-muted small mb-0">
                  {{ t.last_scan }}: {{ timestamp }} (UTC)
                </p>
              {% else %}
                <p class="text-muted small mb-0">
                  {{ t.not_scanned }}. {{ t.scan_button }}.
                </p>
              {% endif %}
            </div>
          </div>

          {% if devices %}
            <div class="table-responsive ndt-table-wrapper">
              <table class="table table-hover table-sm align-middle mb-0" id="devices-table">
                <thead>
                  <tr>
                    <th scope="col">{{ t.status }}</th>
                    <th scope="col">{{ t.ip_address }}</th>
                    <th scope="col">{{ t.hostname }}</th>
                    <th scope="col">{{ t.mac_address }}</th>
                    <th scope="col">{{ t.manufacturer }}</th>
                    <th scope="col">{{ t.actions }}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in devices %}
                    <tr class="ndt-row device-row {% if not d.get('in_subnet', True) %}ndt-external-device{% endif %} {% if d.get('is_new') %}ndt-new-device{% endif %}" 
                        data-device='{{ d | tojson }}'
                        data-known="{{ 'true' if d.known else 'false' }}"
                        data-external="{{ 'true' if not d.get('in_subnet', True) else 'false' }}"
                        data-new="{{ 'true' if d.get('is_new') else 'false' }}">
                      <td>
                        <div class="d-flex flex-column gap-1">
                          {% if d.known %}
                            <span class="badge bg-success-subtle text-success">{{ t.known }}</span>
                          {% else %}
                            <span class="badge bg-warning-subtle text-warning">{{ t.unknown }}</span>
                          {% endif %}
                          {% if not d.get('in_subnet', True) %}
                            <span class="badge ndt-external-badge">üåê {{ t.external }}</span>
                          {% endif %}
                          {% if d.get('is_new') %}
                            <span class="badge bg-info-subtle text-info" style="font-size: 0.65rem;">‚ú® {{ t.new }}</span>
                          {% endif %}
                        </div>
                      </td>
                      <td class="ndt-ip">
                        {{ d.ip }}
                        {% if d.get('osint') %}
                          <span class="badge bg-info-subtle text-info ms-1" style="font-size: 0.65rem;" title="OSINT data beschikbaar">üîç</span>
                        {% endif %}
                        {% if d.get('open_ports') %}
                          <span class="badge bg-primary-subtle text-primary ms-1" style="font-size: 0.65rem;" title="{{ d.open_ports | length }} open poorten">üîå</span>
                        {% endif %}
                      </td>
                      <td>
                        {{ d.hostname or '-' }}
                        {% if d.get('note') %}
                          <br><small class="text-muted">üìù {{ d.note }}</small>
                        {% endif %}
                      </td>
                      <td><code>{{ d.mac or '-' }}</code></td>
                      <td>{{ d.vendor or t.unknown }}</td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          {% if d.known %}
                            <button class="btn ndt-btn-modern ndt-btn-warning mark-unknown-btn" data-mac="{{ d.mac }}">
                              {{ t.unknown }}
                            </button>
                          {% else %}
                            <button class="btn ndt-btn-modern ndt-btn-success mark-known-btn" data-mac="{{ d.mac }}">
                              {{ t.known }}
                            </button>
                          {% endif %}
                          <button class="btn ndt-btn-modern ndt-btn-info details-btn" data-device='{{ d | tojson }}'>
                            {{ t.details }}
                          </button>
                          <button class="btn ndt-btn-modern ndt-btn-secondary note-btn" data-mac="{{ d.mac }}" data-note="{{ d.get('note', '') }}" title="{{ t.note }}">
                            üìù
                          </button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="d-flex flex-column align-items-center justify-content-center py-4 text-muted">
              <p class="mb-1">{{ t.no_devices }}</p>
              <p class="small mb-0">{{ t.scan_to_discover }}</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Scan History -->
      {% if history %}
      <div class="card shadow-sm ndt-card ndt-card-dark mt-3">
        <div class="card-body">
          <h5 class="h6 mb-3">{{ t.scan_history }}</h5>
          <div class="table-responsive ndt-no-scrollbar">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>{{ t.time }}</th>
                  <th>{{ t.devices }}</th>
                  <th>{{ t.new_devices }}</th>
                  <th>{{ t.removed_devices }}</th>
                </tr>
              </thead>
              <tbody>
                {% for h in history[-10:] %}
                <tr>
                  <td>{{ h.timestamp[:19] }}</td>
                  <td>{{ h.device_count }}</td>
                  <td><span class="badge bg-success-subtle text-success">{{ h.new_count }}</span></td>
                  <td><span class="badge bg-danger-subtle text-danger">{{ h.removed_count }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}

      <p class="ndt-footer-note small mt-3">
        {{ t.scan_note }}
      </p>
    </div>

    <!-- Device Details Modal -->
    <div class="modal fade" id="deviceModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content ndt-modal-dark">
          <div class="modal-header">
            <h5 class="modal-title">{{ t.details }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="device-details">
            <!-- Dynamisch ingevuld -->
          </div>
        </div>
      </div>
    </div>

    <!-- Note Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content ndt-modal-dark">
          <div class="modal-header">
            <h5 class="modal-title">{{ t.add_note }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea class="form-control ndt-textarea-dark" id="note-text" rows="3" placeholder="{{ t.note }}..."></textarea>
            <input type="hidden" id="note-mac">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t.cancel }}</button>
            <button type="button" class="btn btn-primary" id="save-note-btn">{{ t.save }}</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const lang = '{{ lang }}';
      const theme = '{{ theme }}';
      const translations = {
        nl: {
          ip_address: 'IP-adres',
          mac_address: 'MAC-adres',
          hostname: 'Hostname',
          manufacturer: 'Fabrikant',
          note: 'Notitie',
          location: 'Locatie',
          status: 'Status',
          in_subnet: 'Binnen subnet',
          out_subnet: 'Buiten subnet (verbonden)',
          known: 'Bekend',
          unknown: 'Onbekend',
          open_ports: 'Open Poorten',
          port_scanning: 'Port Scanning',
          scan_ports: 'Scan poorten',
          no_open_ports: 'Geen open poorten gevonden',
          port_scan_error: 'Fout bij port scan',
          services: 'Services',
          osint_intelligence: 'OSINT Intelligence',
          close: 'Sluiten',
          cancel: 'Annuleren',
          save: 'Opslaan',
          error_save_note: 'Fout bij opslaan notitie',
          error_change_lang: 'Fout bij wijzigen taal',
          error_mark_known: 'Fout bij markeren als bekend',
          error_mark_unknown: 'Fout bij markeren als onbekend'
        },
        en: {
          ip_address: 'IP address',
          mac_address: 'MAC address',
          hostname: 'Hostname',
          manufacturer: 'Manufacturer',
          note: 'Note',
          location: 'Location',
          status: 'Status',
          in_subnet: 'In subnet',
          out_subnet: 'Outside subnet (connected)',
          known: 'Known',
          unknown: 'Unknown',
          open_ports: 'Open Ports',
          port_scanning: 'Port Scanning',
          scan_ports: 'Scan ports',
          no_open_ports: 'No open ports found',
          port_scan_error: 'Error during port scan',
          services: 'Services',
          osint_intelligence: 'OSINT Intelligence',
          close: 'Close',
          cancel: 'Cancel',
          save: 'Save',
          error_save_note: 'Error saving note',
          error_change_lang: 'Error changing language',
          error_mark_known: 'Error marking as known',
          error_mark_unknown: 'Error marking as unknown'
        }
      };
      const t = translations[lang] || translations.nl;
      
      // Search/filter functionaliteit
      const searchInput = document.getElementById('search-input');
      const deviceRows = document.querySelectorAll('.device-row');
      const deviceCount = document.getElementById('device-count');
      const filterRadios = document.querySelectorAll('input[name="filter"]');

      function applyFilters() {
        const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
        const selectedFilter = document.querySelector('input[name="filter"]:checked')?.value || 'all';
        let visibleCount = 0;

        deviceRows.forEach(row => {
          const text = row.textContent.toLowerCase();
          const matchesSearch = !searchQuery || text.includes(searchQuery);
          
          const isKnown = row.dataset.known === 'true';
          const isExternal = row.dataset.external === 'true';
          const isNew = row.dataset.new === 'true';
          
          let matchesFilter = true;
          if (selectedFilter === 'known') matchesFilter = isKnown;
          else if (selectedFilter === 'unknown') matchesFilter = !isKnown;
          else if (selectedFilter === 'external') matchesFilter = isExternal;
          else if (selectedFilter === 'new') matchesFilter = isNew;
          
          const visible = matchesSearch && matchesFilter;
          row.style.display = visible ? '' : 'none';
          if (visible) visibleCount++;
        });

        if (deviceCount) deviceCount.textContent = visibleCount;
      }

      if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
      }
      
      filterRadios.forEach(radio => {
        radio.addEventListener('change', applyFilters);
      });

      // Markeer als bekend/onbekend
      document.querySelectorAll('.mark-known-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const mac = btn.dataset.mac;
          try {
            const res = await fetch('/api/mark-known', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({mac: mac})
            });
            if (res.ok) location.reload();
          } catch (e) {
            alert(t.error_mark_known);
          }
        });
      });

      document.querySelectorAll('.mark-unknown-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const mac = btn.dataset.mac;
          try {
            const res = await fetch('/api/mark-unknown', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({mac: mac})
            });
            if (res.ok) location.reload();
          } catch (e) {
            alert(t.error_mark_unknown);
          }
        });
      });

      // Notitie functionaliteit
      const noteModal = new bootstrap.Modal(document.getElementById('noteModal'));
      document.querySelectorAll('.note-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('note-mac').value = btn.dataset.mac;
          document.getElementById('note-text').value = btn.dataset.note || '';
          noteModal.show();
        });
      });

      document.getElementById('save-note-btn').addEventListener('click', async () => {
        const mac = document.getElementById('note-mac').value;
        const note = document.getElementById('note-text').value;
        try {
          const res = await fetch('/api/note', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mac: mac, note: note})
          });
          if (res.ok) {
            noteModal.hide();
            location.reload();
          }
        } catch (e) {
          alert(t.error_save_note);
        }
      });

      // Port scan functionaliteit (in Details modal)
      document.addEventListener('click', async (e) => {
        if (e.target.id === 'scan-ports-btn') {
          const btn = e.target;
          const ip = btn.dataset.ip;
          const resultDiv = document.getElementById('ports-result');
          btn.disabled = true;
          btn.innerHTML = `‚è≥ ${t.scanning}`;
          resultDiv.innerHTML = '';
          
          try {
            const res = await fetch('/api/portscan', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ip: ip})
            });
            const data = await res.json();
            if (data.success) {
              if (data.ports && data.ports.length > 0) {
                resultDiv.innerHTML = `
                  <div class="d-flex flex-wrap gap-2">
                    ${data.services.map(s => `<span class="badge ndt-port-badge">${s.port} (${s.service})</span>`).join('')}
                  </div>
                `;
              } else {
                resultDiv.innerHTML = `<div class="text-muted small">${t.no_open_ports}</div>`;
              }
            }
          } catch (e) {
            resultDiv.innerHTML = `<div class="text-danger small">${t.port_scan_error}</div>`;
          } finally {
            btn.disabled = false;
            btn.innerHTML = t.scan_ports;
          }
        }
      });

      // Device details modal
      const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
      document.querySelectorAll('.details-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const device = JSON.parse(btn.dataset.device);
          const details = document.getElementById('device-details');
          
          let osintHtml = '';
          if (device.osint) {
            const osint = device.osint;
            osintHtml = `<hr class="my-3"><h6 class="mb-3">üîç ${t.osint_intelligence}</h6>`;
            
            if (osint.virustotal) {
              const vt = osint.virustotal;
              const repColor = vt.reputation > 0 ? 'success' : vt.reputation < 0 ? 'danger' : 'secondary';
              osintHtml += `
                <div class="mb-3">
                  <strong>VirusTotal:</strong>
                  <div class="ms-3 mt-1">
                    <span class="badge bg-${repColor}">Reputation: ${vt.reputation || 0}</span>
                    <span class="badge bg-success-subtle text-success ms-1">Harmless: ${vt.harmless || 0}</span>
                    ${vt.malicious > 0 ? `<span class="badge bg-danger ms-1">‚ö†Ô∏è Malicious: ${vt.malicious}</span>` : ''}
                    ${vt.suspicious > 0 ? `<span class="badge bg-warning ms-1">Suspicious: ${vt.suspicious}</span>` : ''}
                    ${vt.as_owner ? `<div class="small text-muted mt-1">AS Owner: ${vt.as_owner}</div>` : ''}
                    ${vt.country ? `<div class="small text-muted">Country: ${vt.country}</div>` : ''}
                  </div>
                </div>
              `;
            }
            
            if (osint.abuseipdb) {
              const abuse = osint.abuseipdb;
              const abuseColor = abuse.abuse_confidence > 50 ? 'danger' : abuse.abuse_confidence > 25 ? 'warning' : 'success';
              osintHtml += `
                <div class="mb-3">
                  <strong>AbuseIPDB:</strong>
                  <div class="ms-3 mt-1">
                    <span class="badge bg-${abuseColor}">Abuse Confidence: ${abuse.abuse_confidence || 0}%</span>
                    ${abuse.usage_type ? `<div class="small text-muted mt-1">Usage: ${abuse.usage_type}</div>` : ''}
                    ${abuse.isp ? `<div class="small text-muted">ISP: ${abuse.isp}</div>` : ''}
                    ${abuse.country ? `<div class="small text-muted">Country: ${abuse.country}</div>` : ''}
                  </div>
                </div>
              `;
            }
            
            if (osint.whois && Object.keys(osint.whois).length > 0) {
              const whois = osint.whois;
              const locationParts = [];
              if (whois.city) locationParts.push(whois.city);
              if (whois.region) locationParts.push(whois.region);
              if (whois.country) locationParts.push(whois.country);
              
              osintHtml += `
                <div class="mb-3">
                  <strong>WHOIS / Geolocation:</strong>
                  <div class="ms-3 mt-1">
                    ${locationParts.length > 0 ? `<div class="small">üìç ${locationParts.join(', ')}</div>` : ''}
                    ${whois.isp ? `<div class="small text-muted">ISP: ${whois.isp}</div>` : ''}
                    ${whois.org ? `<div class="small text-muted">Organization: ${whois.org}</div>` : ''}
                    ${whois.as ? `<div class="small text-muted">AS: ${whois.as}${whois.asname ? ` (${whois.asname})` : ''}</div>` : ''}
                    ${whois.timezone ? `<div class="small text-muted">Timezone: ${whois.timezone}</div>` : ''}
                    ${whois.lat && whois.lon ? `<div class="small text-muted">Coordinates: ${whois.lat}, ${whois.lon}</div>` : ''}
                  </div>
                </div>
              `;
            }
            
            if (osint.ipinfo && Object.keys(osint.ipinfo).length > 0) {
              const ipinfo = osint.ipinfo;
              const locationParts = [];
              if (ipinfo.city) locationParts.push(ipinfo.city);
              if (ipinfo.region) locationParts.push(ipinfo.region);
              if (ipinfo.country) locationParts.push(ipinfo.country);
              
              osintHtml += `
                <div class="mb-3">
                  <strong>IPinfo:</strong>
                  <div class="ms-3 mt-1">
                    ${locationParts.length > 0 ? `<div class="small">üìç ${locationParts.join(', ')}</div>` : ''}
                    ${ipinfo.org ? `<div class="small text-muted">Organization: ${ipinfo.org}</div>` : ''}
                    ${ipinfo.hostname ? `<div class="small text-muted">Hostname: ${ipinfo.hostname}</div>` : ''}
                    ${ipinfo.loc ? `<div class="small text-muted">Coordinates: ${ipinfo.loc}</div>` : ''}
                    ${ipinfo.timezone ? `<div class="small text-muted">Timezone: ${ipinfo.timezone}</div>` : ''}
                    ${ipinfo.postal ? `<div class="small text-muted">Postal: ${ipinfo.postal}</div>` : ''}
                  </div>
                </div>
              `;
            }
          }
          
          let portsHtml = '';
          if (device.open_ports && device.open_ports.length > 0) {
            // Toon alleen als er ports zijn gevonden
            portsHtml = `
              <hr class="my-3">
              <h6 class="mb-3">üîå ${t.open_ports}</h6>
              <div class="d-flex flex-wrap gap-2">
                ${device.open_ports.map(p => `<span class="badge ndt-port-badge">${p}</span>`).join('')}
              </div>
              ${device.services ? `<div class="small text-muted mt-2">${t.services}: ${device.services.join(', ')}</div>` : ''}
            `;
          }
          // Port scanning sectie wordt NIET getoond als er geen ports zijn
          
          details.innerHTML = `
            <dl class="row">
              <dt class="col-sm-4">${t.ip_address}:</dt>
              <dd class="col-sm-8"><code>${device.ip || '-'}</code></dd>
              <dt class="col-sm-4">${t.mac_address}:</dt>
              <dd class="col-sm-8"><code>${device.mac || '-'}</code></dd>
              <dt class="col-sm-4">${t.hostname}:</dt>
              <dd class="col-sm-8">${device.hostname || '-'}</dd>
              <dt class="col-sm-4">${t.manufacturer}:</dt>
              <dd class="col-sm-8">${device.vendor || t.unknown}</dd>
              ${device.note ? `<dt class="col-sm-4">${t.note}:</dt><dd class="col-sm-8">${device.note}</dd>` : ''}
              <dt class="col-sm-4">${t.location}:</dt>
              <dd class="col-sm-8">
                <span class="badge ${device.in_subnet !== false ? 'bg-primary-subtle text-primary' : 'bg-info-subtle text-info'}">
                  ${device.in_subnet !== false ? t.in_subnet : t.out_subnet}
                </span>
              </dd>
              <dt class="col-sm-4">${t.status}:</dt>
              <dd class="col-sm-8">
                <span class="badge ${device.known ? 'bg-success-subtle text-success' : 'bg-warning-subtle text-warning'}">
                  ${device.known ? t.known : t.unknown}
                </span>
              </dd>
            </dl>
            ${portsHtml}
            ${osintHtml}
          `;
          modal.show();
        });
      });

      // Taal switcher
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const newLang = btn.dataset.lang;
          const langBtn = document.getElementById('lang-dropdown-btn');
          
          // Update button text immediately for better UX
          if (langBtn) {
            langBtn.textContent = newLang === 'nl' ? 'üá≥üá± Nederlands' : 'üá¨üáß English';
          }
          
          try {
            const res = await fetch('/api/set-lang', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({lang: newLang})
            });
            if (res.ok) {
              location.reload();
            } else {
              // Revert on error
              if (langBtn) {
                langBtn.textContent = lang === 'nl' ? 'üá≥üá± Nederlands' : 'üá¨üáß English';
              }
            }
          } catch (e) {
            alert(t.error_change_lang);
            // Revert on error
            if (langBtn) {
              langBtn.textContent = lang === 'nl' ? 'üá≥üá± Nederlands' : 'üá¨üáß English';
            }
          }
        });
      });

      // Scan form loading indicator with polling
      const scanForm = document.getElementById('scan-form');
      const scanBtn = document.getElementById('scan-btn');
      const scanText = document.querySelector('.ndt-scan-text');
      const scanLoader = document.querySelector('.ndt-scan-loader');
      
      if (scanForm) {
        scanForm.addEventListener('submit', (e) => {
          // Show loading state immediately
          if (scanBtn) {
            scanBtn.disabled = true;
            if (scanText) scanText.classList.add('d-none');
            if (scanLoader) scanLoader.classList.remove('d-none');
          }
          
          // Poll for scan completion
          let pollCount = 0;
          const maxPolls = 600; // Max 5 minuten (600 * 500ms)
          const checkStatus = async () => {
            pollCount++;
            try {
              const res = await fetch('/api/scan-status');
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
              }
              const data = await res.json();
              
              console.log(`[NDT] Poll ${pollCount}: in_progress=${data.in_progress}, message=${data.message}`);
              
              if (!data.in_progress) {
                // Scan completed, reload page
                console.log('[NDT] Scan voltooid, pagina wordt herladen...');
                window.location.reload();
              } else if (pollCount >= maxPolls) {
                // Timeout - reload anyway
                console.log('[NDT] Poll timeout, pagina wordt herladen...');
                window.location.reload();
              } else {
                // Still scanning, check again in 500ms
                setTimeout(checkStatus, 500);
              }
            } catch (e) {
              console.error('[NDT] Poll error:', e);
              if (pollCount >= maxPolls) {
                window.location.reload();
              } else {
                setTimeout(checkStatus, 1000);
              }
            }
          };
          
          // Start polling after a short delay
          setTimeout(checkStatus, 500);
        });
      }
      
      // Check scan status on page load
      const checkScanOnLoad = async () => {
        try {
          const res = await fetch('/api/scan-status');
          const data = await res.json();
          
          if (data.in_progress) {
            // Scan is in progress, show loading state
            if (scanBtn) {
              scanBtn.disabled = true;
              if (scanText) scanText.classList.add('d-none');
              if (scanLoader) scanLoader.classList.remove('d-none');
            }
            
            // Poll until complete
            let pollCount = 0;
            const maxPolls = 600; // Max 5 minuten (600 * 500ms)
            const pollStatus = async () => {
              pollCount++;
              try {
                const res = await fetch('/api/scan-status');
                if (!res.ok) {
                  throw new Error(`HTTP ${res.status}`);
                }
                const data = await res.json();
                
                console.log(`[NDT] Poll ${pollCount}: in_progress=${data.in_progress}, message=${data.message}`);
                
                if (!data.in_progress) {
                  // Scan completed, reload page
                  console.log('[NDT] Scan voltooid, pagina wordt herladen...');
                  window.location.reload();
                } else if (pollCount >= maxPolls) {
                  // Timeout - reload anyway
                  console.log('[NDT] Poll timeout, pagina wordt herladen...');
                  window.location.reload();
                } else {
                  // Still scanning, check again in 500ms
                  setTimeout(pollStatus, 500);
                }
              } catch (e) {
                console.error('[NDT] Poll error:', e);
                if (pollCount >= maxPolls) {
                  window.location.reload();
                } else {
                  setTimeout(pollStatus, 1000);
                }
              }
            };
            setTimeout(pollStatus, 500);
          }
        } catch (e) {
          // Ignore errors on page load
        }
      };
      checkScanOnLoad();
    </script>
  </body>
</html>
